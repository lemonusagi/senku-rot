<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senku Grandpa Achievements Tracker</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --pixel-bg: #1a1a2e;
            --pixel-border: #4e4e4e;
            --pixel-accent: #f4b41a;
            --poring-pink: #ff8fb1;
            --poring-light: #ffc2d1;
            --poring-blush: #ff5e8e;
            --mastering-gold: #fcd34d;
            --perfect-green: #22c55e;
            --perfect-light: #86efac;
            --angry-red: #ef4444;
        }

        body {
            background-color: #0f0f1b;
            color: #e0e0e0;
            font-family: 'VT323', monospace;
            overflow-x: hidden;
        }

        .pixel-box {
            background: var(--pixel-bg);
            border: 4px solid var(--pixel-border);
            position: relative;
            box-shadow: inset -4px -4px 0px 0px #00000055, 4px 4px 0px 0px #000000;
        }

        .pixel-title {
            font-size: 2.5rem;
            color: var(--pixel-accent);
            text-shadow: 3px 3px 0px #000;
            letter-spacing: 2px;
            display: block;
            width: 100%;
        }

        .mascot-container {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-pixel {
            appearance: none;
            width: 32px;
            height: 32px;
            background: #2d2d44;
            border: 4px solid #4e4e4e;
            cursor: pointer;
            position: relative;
            transition: all 0.1s;
            image-rendering: pixelated;
        }

        .checkbox-pixel:checked {
            background: var(--poring-pink);
            border-color: var(--poring-light);
            animation: poring-bounce 0.4s ease-out;
        }

        .slime-rain {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background-image: 
                linear-gradient(90deg, var(--poring-pink) 2px, transparent 2px),
                linear-gradient(0deg, var(--poring-pink) 2px, transparent 2px);
            background-size: 12px 12px;
            animation: jelly-cube-fall 1.2s linear infinite;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .slime-rain.active { opacity: 0.3; }

        @keyframes jelly-cube-fall {
            from { background-position: 0 0; }
            to { background-position: 12px 24px; }
        }

        .quest-row {
            border-bottom: 4px solid #2d2d44;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: background-color 0.3s;
        }

        .transformed { 
            background-color: rgba(255, 143, 177, 0.25) !important; 
            border-left: 6px solid var(--poring-pink);
            box-shadow: inset 4px 0 10px rgba(255, 94, 142, 0.2);
        }

        .completed-text {
            color: #ffc2d1;
            text-shadow: 1px 1px 0px #000;
        }

        .slime-bar-container {
            height: 32px;
            background: #000;
            border: 4px solid var(--pixel-border);
            position: relative;
            overflow: hidden;
            image-rendering: pixelated;
        }

        .slime-bar-fill {
            height: 100%;
            background: var(--poring-pink);
            box-shadow: inset 0 4px 0 var(--poring-light);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .achievement-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            width: 90%;
            max-width: 400px;
            z-index: 1000;
            background: #000;
            border: 6px solid var(--mastering-gold);
            padding: 16px;
            text-align: center;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 0 4px #000, 8px 8px 0 rgba(0,0,0,0.5);
        }

        .achievement-toast.show { transform: translateX(-50%) translateY(0); }

        .btn-close-toast {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 32px;
            height: 32px;
            background: var(--angry-red);
            border: 4px solid #000;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 0 #000;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .cal-pixel-day {
            aspect-ratio: 1/1;
            background: #2d2d44;
            border: 2px solid #4e4e4e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            position: relative;
        }

        .day-star { position: absolute; top: 2px; right: 2px; font-size: 0.8rem; color: #fff; text-shadow: 1px 1px 0 #000; }
        .day-full { background: var(--perfect-green); color: #000; border-color: var(--perfect-light); }
        .day-partial { background: #3b82f6; color: #fff; }
        .day-selected { outline: 4px solid var(--pixel-accent); z-index: 10; }
        .day-today { color: var(--pixel-accent); font-weight: bold; }

        .btn-pixel {
            background: #4e4e4e;
            border: 4px solid #000;
            box-shadow: inset -4px -4px 0 #222;
            padding: 8px 16px;
            color: white;
            text-transform: uppercase;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .tab-active { background: var(--pixel-accent); color: #000; border-color: #b45309; }

        .achievement-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            margin-bottom: 12px;
            filter: grayscale(1);
            opacity: 0.6;
            transition: all 0.3s;
        }

        .achievement-unlocked { filter: grayscale(0); opacity: 1; border-color: var(--pixel-accent); background: #24243e; }
        .lock-icon { font-size: 1.5rem; color: #666; }
        
        .floating { animation: floating 3s ease-in-out infinite; }
        @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .pixel-sprite { width: 100%; height: 100%; image-rendering: pixelated; }
        .category-icon { width: 32px; height: 32px; flex-shrink: 0; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="achievement-toast" class="achievement-toast">
        <button id="close-toast" class="btn-close-toast">X</button>
        <h4 class="text-mastering-gold text-lg uppercase tracking-widest mb-1">Achievement Unlocked!</h4>
        <p id="toast-title" class="text-white text-xl"></p>
    </div>

    <div class="max-w-md mx-auto">
        <div class="flex mb-8 gap-2">
            <button id="tab-list" class="btn-pixel flex-1 tab-active">Quests</button>
            <button id="tab-calendar" class="btn-pixel flex-1">Archives</button>
            <button id="tab-achievements" class="btn-pixel flex-1">Trophies</button>
        </div>

        <header class="mb-6 flex flex-col items-center text-center">
            <div class="mascot-container">
                <div id="mascot-sprite" class="floating w-24 h-24"></div>
            </div>
            <h1 id="view-title" class="pixel-title uppercase mt-2 mb-2">Quest Log</h1>
            <p id="current-date-label" class="text-xl text-slate-500 mb-4"></p>
            
            <div id="quest-stats-section" class="pixel-box w-full p-4 bg-slate-900 mb-4">
                <p class="text-lg uppercase mb-2">Daily Progress</p>
                <div class="text-4xl mb-4"><span id="done-count">0</span> / <span id="total-count">0</span></div>
                <div class="slime-bar-container">
                    <div id="progress-bar" class="slime-bar-fill"></div>
                    <div id="jelly-rain" class="slime-rain"></div>
                </div>
            </div>
        </header>

        <div id="view-list-container">
            <div class="mb-6 flex gap-2">
                <button id="complete-all-btn" class="btn-pixel flex-1 bg-yellow-600 border-yellow-400 font-bold hover:brightness-110 active:scale-95 transition-all">AUTO-COMPLETE</button>
                <button id="reset-btn" class="btn-pixel flex-1 bg-red-900 text-white border-red-500 hover:brightness-110">CLEAR DAY</button>
            </div>
            
            <main id="list-container" class="space-y-6"></main>
        </div>

        <div id="view-calendar-container" class="hidden">
            <div class="pixel-box p-4">
                <div class="flex justify-between items-center mb-6">
                    <button id="prev-month" class="text-2xl text-yellow-500">â—€</button>
                    <h2 id="month-label" class="text-2xl uppercase">Month</h2>
                    <button id="next-month" class="text-2xl text-yellow-500">â–¶</button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-xs text-slate-500 mb-4">
                    <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                </div>
                <div id="calendar-days" class="calendar-grid"></div>
            </div>
        </div>

        <div id="view-achievements-container" class="hidden">
            <div id="achievement-list">
                <div id="ach-fail" class="pixel-box achievement-card">
                    <div id="icon-fail" class="category-icon"></div>
                    <div class="flex-1">
                        <h3 class="text-xl text-yellow-500">When am I ever going to get rid of my grandpa title in another world</h3>
                        <p class="text-xs text-slate-400 uppercase">A record in your history shows missed tasks</p>
                    </div>
                    <div class="lock-icon">ðŸ”’</div>
                </div>

                <div id="ach-fail-apoc" class="pixel-box achievement-card">
                    <div id="icon-fail-apoc" class="category-icon"></div>
                    <div class="flex-1">
                        <h3 class="text-xl text-yellow-500">Aiya this grandpa miss an AFK event</h3>
                        <p class="text-xs text-slate-400 uppercase">First time missing an APOC Elite quest</p>
                    </div>
                    <div class="lock-icon">ðŸ”’</div>
                </div>

                <div id="ach-fail-gacha" class="pixel-box achievement-card">
                    <div id="icon-fail-gacha" class="category-icon"></div>
                    <div class="flex-1">
                        <h3 class="text-xl text-yellow-500">Grandpa summons are now crying</h3>
                        <p class="text-xs text-slate-400 uppercase">First time missing a Gacha Summon window</p>
                    </div>
                    <div class="lock-icon">ðŸ”’</div>
                </div>

                <div id="ach-fail-world" class="pixel-box achievement-card">
                    <div id="icon-fail-world" class="category-icon"></div>
                    <div class="flex-1">
                        <h3 class="text-xl text-yellow-500">HELLO GRANDPA OUR NATION DEPENDS ON YOU!!</h3>
                        <p class="text-xs text-slate-400 uppercase">First time missing a World Event</p>
                    </div>
                    <div class="lock-icon">ðŸ”’</div>
                </div>

                <hr class="border-slate-700 my-4">

                <div id="ach-first" class="pixel-box achievement-card">
                    <div id="icon-first" class="category-icon"></div>
                    <div class="flex-1">
                        <h3 class="text-xl text-yellow-500">I am not a grandpa anymore</h3>
                        <p class="text-xs text-slate-400 uppercase">Achieve your first perfect daily score</p>
                    </div>
                    <div class="lock-icon">ðŸ”’</div>
                </div>

                <div id="ach-week" class="pixel-box achievement-card">
                    <div id="icon-week" class="category-icon"></div>
                    <div class="flex-1">
                        <h3 class="text-xl text-yellow-500">I am finally not a grandpa for a week</h3>
                        <p class="text-xs text-slate-400 uppercase">Maintain a 7-day perfect streak</p>
                    </div>
                    <div class="lock-icon">ðŸ”’</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            const taskData = [
                { category: "APOC ELITE", items: ["12:00 PM APOC", "5:00 PM APOC", "9:30 PM APOC"], require: "all" },
                { category: "GACHA SUMMONS", items: ["12:30 PM", "3:30 PM", "6:00 PM", "9:00 PM"], require: 2 },
                { category: "BANDIT INVASION", items: ["12:15 PM", "4:15 PM", "10:30 PM"], require: 1 },
                { category: "FATE TRIALS", items: ["12:45 PM", "4:45 PM", "7:45 PM", "9:45 PM"], require: 2 },
                { category: "BOUNTY HUNTER", items: ["20 KILLS", "5 FOLK", "3 UR Assist", "2 UR Submit", "1 ENEMY UR"], require: "all" },
                { category: "SHADOW RAID", items: ["Entry 1", "Entry 2"], require: "all" },
                { category: "WORLD EVENTS", items: ["8:00 PM", "8:30 PM", "9:30 PM"], require: "all" }
            ];

            const createPoringSVG = (bodyColor, blushColor, highlightColor, hasCrown = false, mood = 'happy') => `
                <svg viewBox="0 0 32 32" class="pixel-sprite">
                    <path d="M12 4h8v2h4v2h2v4h2v8h-2v4h-2v2h-4v2H8v-2H4v-2H2v-4H0v-8h2v-4h2v-2h4v-2h4z" fill="#000" transform="translate(1,1)"/>
                    <path d="M12 4h8v2h4v2h2v4h2v8h-2v4h-2v2h-4v2H8v-2H4v-2H2v-4H0v-8h2v-4h2v-2h4v-2h4z" fill="${bodyColor}"/>
                    ${mood === 'angry' ? `
                        <path d="M9 14l3 3M23 14l-3 3" stroke="#000" stroke-width="2"/>
                        <rect x="14" y="21" width="4" height="2" fill="#000" />
                    ` : mood === 'crying' ? `
                        <rect x="8" y="16" width="3" height="3" fill="#000" />
                        <rect x="21" y="16" width="3" height="3" fill="#000" />
                        <rect x="8" y="19" width="2" height="4" fill="#60a5fa" />
                        <rect x="22" y="19" width="2" height="4" fill="#60a5fa" />
                        <path d="M13 23h6" stroke="#000" stroke-width="1" />
                    ` : mood === 'disappointed' ? `
                        <rect x="7" y="15" width="5" height="2" fill="#000" />
                        <rect x="20" y="15" width="5" height="2" fill="#000" />
                        <rect x="11" y="23" width="10" height="2" fill="#000" />
                    ` : `
                        <rect x="8" y="17" width="4" height="1" fill="#000" />
                        <rect x="20" y="17" width="4" height="1" fill="#000" />
                        <path d="M12 21h8" stroke="#000" stroke-width="1" />
                    `}
                    ${hasCrown ? '<path d="M10 0h12v4H10z" fill="#ef4444"/><rect x="15" y="0" width="2" height="2" fill="#fcd34d"/>' : ''}
                </svg>`;

            const sprites = {
                poring: createPoringSVG("#ff8fb1", "#ff5e8e", "#ffc2d1"),
                marin: createPoringSVG("#93c5fd", "#3b82f6", "#dbeafe"),
                mastering: createPoringSVG("#fcd34d", "#f59e0b", "#fef3c7", true),
                angry: createPoringSVG("#ef4444", "#991b1b", "#f87171", false, 'angry'),
                crying: createPoringSVG("#ff8fb1", "#ff5e8e", "#ffc2d1", false, 'crying'),
                disappointed: createPoringSVG("#ff8fb1", "#ff5e8e", "#ffc2d1", false, 'disappointed')
            };

            let currentViewDate = new Date();
            let calendarNavDate = new Date();
            let history = JSON.parse(localStorage.getItem('pixel_quest_v2_history')) || {};
            let persistentUnlocks = JSON.parse(localStorage.getItem('pixel_quest_v2_unlocks')) || { 
                grandpa_fail: false, 
                fail_apoc: false,
                fail_gacha: false,
                fail_world: false,
                first_perfect: false, 
                week_streak: false,
                months: [] 
            };

            let toastTimeout;

            function getDS(date) { 
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            function getDayStats(dateKey) {
                const state = history[dateKey] || {};
                let completedCount = 0;
                let someMarked = false;
                let missedCategories = [];

                taskData.forEach((section, sIdx) => {
                    let innerCount = 0;
                    section.items.forEach((_, iIdx) => {
                        if (state[`task-${sIdx}-${iIdx}`]) {
                            innerCount++;
                            someMarked = true;
                        }
                    });
                    const req = section.require === "all" ? section.items.length : section.require;
                    if (innerCount >= req) {
                        completedCount++;
                    } else {
                        missedCategories.push(section.category);
                    }
                });

                return {
                    completed: completedCount,
                    total: taskData.length,
                    perfect: completedCount === taskData.length,
                    some: someMarked,
                    missed: missedCategories
                };
            }

            function showToast(title) {
                clearTimeout(toastTimeout);
                $('#toast-title').text(title);
                $('#achievement-toast').addClass('show');
                toastTimeout = setTimeout(() => $('#achievement-toast').removeClass('show'), 6000);
            }

            $('#close-toast').on('click', function() {
                $('#achievement-toast').removeClass('show');
                clearTimeout(toastTimeout);
            });

            function checkAchievements() {
                const sortedDateKeys = Object.keys(history).sort();
                const todayKey = getDS(new Date());
                let newlyUnlocked = [];

                // Reset trackers to re-evaluate based on current history
                let currentFails = {
                    any: false,
                    apoc: false,
                    gacha: false,
                    world: false
                };

                for (let key of sortedDateKeys) {
                    const stats = getDayStats(key);
                    if (!stats.some) continue;

                    // Only count past dates for Grandpa failures
                    const isHistory = key < todayKey;

                    if (isHistory) {
                        if (!stats.perfect) currentFails.any = true;
                        if (stats.missed.includes("APOC ELITE")) currentFails.apoc = true;
                        if (stats.missed.includes("GACHA SUMMONS")) currentFails.gacha = true;
                        if (stats.missed.includes("WORLD EVENTS")) currentFails.world = true;
                    }
                }

                // If a Grandpa failure tracker goes from false to true, it's "Newly Unlocked"
                if (currentFails.any && !persistentUnlocks.grandpa_fail) newlyUnlocked.push("When am I ever going to get rid of my grandpa title in another world");
                if (currentFails.apoc && !persistentUnlocks.fail_apoc) newlyUnlocked.push("Aiya this grandpa miss an AFK event");
                if (currentFails.gacha && !persistentUnlocks.fail_gacha) newlyUnlocked.push("Grandpa summons are now crying");
                if (currentFails.world && !persistentUnlocks.fail_world) newlyUnlocked.push("HELLO GRANDPA OUR NATION DEPENDS ON YOU!!");

                // Update persistent state (can go back to false if all past dates are now perfect)
                persistentUnlocks.grandpa_fail = currentFails.any;
                persistentUnlocks.fail_apoc = currentFails.apoc;
                persistentUnlocks.fail_gacha = currentFails.gacha;
                persistentUnlocks.fail_world = currentFails.world;

                // First Perfect (One-way unlock)
                if (!persistentUnlocks.first_perfect) {
                    for (let key of sortedDateKeys) {
                        if (getDayStats(key).perfect) {
                            persistentUnlocks.first_perfect = true;
                            newlyUnlocked.push("I am not a grandpa anymore");
                            break;
                        }
                    }
                }

                // Streak (Re-evaluable)
                let highestStreak = 0;
                let currentStreak = 0;
                if (sortedDateKeys.length > 0) {
                    const firstDate = new Date(sortedDateKeys[0]);
                    const lastDate = new Date();
                    const tempDate = new Date(firstDate);
                    while(tempDate <= lastDate) {
                        const key = getDS(tempDate);
                        if (getDayStats(key).perfect) {
                            currentStreak++;
                            highestStreak = Math.max(highestStreak, currentStreak);
                        } else { currentStreak = 0; }
                        tempDate.setDate(tempDate.getDate() + 1);
                    }
                }
                const reachedWeek = highestStreak >= 7;
                if (reachedWeek && !persistentUnlocks.week_streak) newlyUnlocked.push("I am finally not a grandpa for a week");
                persistentUnlocks.week_streak = reachedWeek;

                localStorage.setItem('pixel_quest_v2_unlocks', JSON.stringify(persistentUnlocks));
                if (newlyUnlocked.length > 0) {
                    newlyUnlocked.forEach(title => showToast(title));
                }
                updateAchievementUI();
            }

            function updateAchievementUI() {
                $('#ach-fail').toggleClass('achievement-unlocked', persistentUnlocks.grandpa_fail);
                $('#ach-fail .lock-icon').toggle(!persistentUnlocks.grandpa_fail);
                $('#icon-fail').html(sprites.angry);

                $('#ach-fail-apoc').toggleClass('achievement-unlocked', persistentUnlocks.fail_apoc);
                $('#ach-fail-apoc .lock-icon').toggle(!persistentUnlocks.fail_apoc);
                $('#icon-fail-apoc').html(sprites.disappointed);

                $('#ach-fail-gacha').toggleClass('achievement-unlocked', persistentUnlocks.fail_gacha);
                $('#ach-fail-gacha .lock-icon').toggle(!persistentUnlocks.fail_gacha);
                $('#icon-fail-gacha').html(sprites.crying);

                $('#ach-fail-world').toggleClass('achievement-unlocked', persistentUnlocks.fail_world);
                $('#ach-fail-world .lock-icon').toggle(!persistentUnlocks.fail_world);
                $('#icon-fail-world').html(sprites.angry);

                $('#ach-first').toggleClass('achievement-unlocked', persistentUnlocks.first_perfect);
                $('#ach-first .lock-icon').toggle(!persistentUnlocks.first_perfect);
                $('#icon-first').html(sprites.poring);

                $('#ach-week').toggleClass('achievement-unlocked', persistentUnlocks.week_streak);
                $('#ach-week .lock-icon').toggle(!persistentUnlocks.week_streak);
                $('#icon-week').html(sprites.mastering);
            }

            function initList() {
                const dateKey = getDS(currentViewDate);
                const state = history[dateKey] || {};
                const isToday = dateKey === getDS(new Date());

                $('#view-title').text(isToday ? "Quest Log" : "Archive");
                $('#current-date-label').text(currentViewDate.toDateString().toUpperCase());
                
                const $list = $('#list-container').empty();
                $('#total-count').text(taskData.length);

                taskData.forEach((section, sIdx) => {
                    const $sec = $('<div>').addClass('pixel-box overflow-hidden section-block').attr('data-sidx', sIdx);
                    $sec.append(`
                        <div class="p-3 bg-slate-800 border-b-4 border-slate-700 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="category-icon">${sprites.poring}</div>
                                <span class="text-2xl text-yellow-500 pt-1">${section.category}</span>
                            </div>
                        </div>
                    `);

                    const $body = $('<div>');
                    section.items.forEach((item, iIdx) => {
                        const id = `task-${sIdx}-${iIdx}`;
                        const isChecked = !!state[id];
                        const $row = $(`
                            <label class="quest-row cursor-pointer ${isChecked ? 'transformed' : ''}">
                                <input type="checkbox" class="checkbox-pixel task-check" ${isChecked ? 'checked' : ''} data-id="${id}">
                                <span class="text-2xl pt-1 ${isChecked ? 'completed-text' : ''}">${item}</span>
                            </label>
                        `);

                        $row.find('input').on('change', function() {
                            const checked = $(this).is(':checked');
                            if (!history[dateKey]) history[dateKey] = {};
                            history[dateKey][id] = checked;
                            
                            if (!checked) {
                                let hasAny = false;
                                for (let k in history[dateKey]) if (history[dateKey][k]) hasAny = true;
                                if (!hasAny) delete history[dateKey];
                            }

                            localStorage.setItem('pixel_quest_v2_history', JSON.stringify(history));
                            $(this).next().toggleClass('completed-text', checked);
                            $(this).closest('.quest-row').toggleClass('transformed', checked);
                            updateCounters();
                        });
                        $body.append($row);
                    });
                    $sec.append($body);
                    $list.append($sec);
                });
                updateCounters();
            }

            function updateCounters() {
                let completed = 0;
                $('.section-block').each(function() {
                    const sIdx = $(this).data('sidx');
                    const req = taskData[sIdx].require === "all" ? taskData[sIdx].items.length : taskData[sIdx].require;
                    const count = $(this).find('.task-check:checked').length;
                    if (count >= req) {
                        completed++;
                        $(this).css('border-color', 'var(--poring-pink)');
                    } else { $(this).css('border-color', ''); }
                });
                
                $('#done-count').text(completed);
                const pct = (completed / taskData.length) * 100;
                $('#progress-bar').css('width', pct + '%');
                $('#mascot-sprite').html(pct === 100 ? sprites.mastering : (pct > 0 ? sprites.marin : sprites.poring));
                
                if (pct > 0) $('#jelly-rain').addClass('active');
                else $('#jelly-rain').removeClass('active');
            }

            function renderCalendar() {
                const year = calendarNavDate.getFullYear();
                const month = calendarNavDate.getMonth();
                $('#month-label').text(new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(calendarNavDate));
                const first = new Date(year, month, 1).getDay();
                const total = new Date(year, month + 1, 0).getDate();
                const $grid = $('#calendar-days').empty();

                for (let i = 0; i < first; i++) $grid.append('<div></div>');
                for (let day = 1; day <= total; day++) {
                    const d = new Date(year, month, day);
                    const key = getDS(d);
                    const stats = getDayStats(key);
                    let cls = "";
                    if (stats.some) cls = stats.perfect ? "day-full" : "day-partial";
                    if (key === getDS(currentViewDate)) cls += " day-selected";
                    if (key === getDS(new Date())) cls += " day-today";

                    const $day = $(`<div class="cal-pixel-day ${cls}">${day}</div>`).on('click', () => {
                        currentViewDate = d;
                        $('#tab-list').click();
                    });
                    if (stats.perfect) $day.append('<span class="day-star">â˜…</span>');
                    $grid.append($day);
                }
            }

            $('#complete-all-btn').on('click', function() {
                const key = getDS(currentViewDate);
                if (!history[key]) history[key] = {};
                taskData.forEach((s, sIdx) => s.items.forEach((_, iIdx) => history[key][`task-${sIdx}-${iIdx}`] = true));
                localStorage.setItem('pixel_quest_v2_history', JSON.stringify(history));
                initList();
                checkAchievements();
            });

            $('#reset-btn').on('click', () => {
                delete history[getDS(currentViewDate)];
                localStorage.setItem('pixel_quest_v2_history', JSON.stringify(history));
                initList();
                checkAchievements(); 
            });

            $('#tab-list').on('click', function() { 
                $('.btn-pixel').removeClass('tab-active'); $(this).addClass('tab-active');
                $('#view-list-container, #quest-stats-section').show();
                $('#view-calendar-container, #view-achievements-container').hide();
                initList();
                checkAchievements();
            });

            $('#tab-calendar').on('click', function() { 
                $('.btn-pixel').removeClass('tab-active'); $(this).addClass('tab-active');
                $('#view-calendar-container').show();
                $('#view-list-container, #view-achievements-container, #quest-stats-section').hide();
                renderCalendar();
                checkAchievements();
            });

            $('#tab-achievements').on('click', function() { 
                $('.btn-pixel').removeClass('tab-active'); $(this).addClass('tab-active');
                $('#view-achievements-container').show();
                $('#view-list-container, #view-calendar-container, #quest-stats-section').hide();
                $('#view-title').text("Trophies");
                $('#current-date-label').text("NON-GRANDPA RECORDS");
                checkAchievements();
            });

            $('#prev-month').on('click', () => { calendarNavDate.setMonth(calendarNavDate.getMonth() - 1); renderCalendar(); });
            $('#next-month').on('click', () => { calendarNavDate.setMonth(calendarNavDate.getMonth() + 1); renderCalendar(); });

            $('#tab-list').click();
            checkAchievements();
        });
    </script>
</body>
</html>
